name: "Module-CoreNetworking-Test"
run-name: Core Networking Test Deployment ${{ github.run_id }}
on:
  workflow_dispatch:
    inputs:
      location:
        description: "The location to deploy the test example to."
        required: true
        default: 'uksouth'
        type: choice
        options:
          - 'uksouth'
          - 'ukwest'
  pull_request:
    branches:
      - main

env:
  DEPLOYMENT_FILE: ${{ github.workspace }}/example/example.bicep
  DEPLOYMENT_NAME: Module-CoreNetworking-${{ github.event.number }}
  RESOURCE_GROUP_NAME: corenetwork-${{ github.event.number }}
  DEPLOYMENT_LOCATION: ${{ github.event.inputs.location || 'uksouth' }}
    
jobs:
  Setup:
    runs-on: ubuntu-latest
    outputs:
      deployment_file: ${{ env.DEPLOYMENT_FILE }}
      deployment_name: ${{ env.DEPLOYMENT_NAME }}
      resource_group_name: ${{ env.RESOURCE_GROUP_NAME }}
      deployment_location: ${{ env.DEPLOYMENT_LOCATION }}
    steps:
      - run: echo "Completed Setup"
      - name: Create Resource Group
        uses: azure/cli@v2
        with:
          inlineScript: |
            az group create --name ${{ env.RESOURCE_GROUP_NAME }} --location ${{ env.DEPLOYMENT_LOCATION }

  Validate:
    needs: [Setup]
    uses: scankin/bicep-workflows/.github/workflows/bicep-predeploy.yml@main
    with: 
      location: ${{ needs.setup.outputs.deployment_location }}
      deployment_file: ${{ needs.setup.outputs.deployment_file }}
      resource_group_name: ${{ needs.setup.outputs.resource_group_name }}
      deployment_name: ${{ needs.setup.outputs.deployment_name }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      
  Deploy:
    needs: [Setup, Validate]
    uses: scankin/bicep-workflows/.github/workflows/bicep-predeploy.yml@main
    with:
      location: ${{ needs.setup.outputs.deployment_location }}
      deployment_file: ${{ needs.setup.outputs.deployment_file }}
      resource_group_name: ${{ needs.setup.outputs.resource_group_name }}
      deployment_name: ${{ needs.setup.outputs.deployment_name }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}